<html>
<head>
  <title>{{cco: dc:title ?o}}</title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <link href="http://xmlns.com/xmlns-style.css" rel="stylesheet"  type="text/css" />
  <link href="http://smiy.sourceforge.net/css/style.css" rel="stylesheet"  type="text/css" />
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
  <script type="text/javascript" src="turtle.js"></script>

<script>
// need this function
if (typeof String.prototype.startsWith != 'function') {
  String.prototype.startsWith = function (str){
    return this.slice(0, str.length) == str;
  };
}

function MustacheRDF(rdf, ns) {
  this.rdf = rdf;
  this.ns = ns;

  this.reg = /{{(.*?)}}/g; // this is for curly brackets
  
  this.loopBlock = /{{#(.*?)}}([\s\S]*?){{\/}}/g;
  this.singleBlock = /{{\.}}/g;

  this.init();
}
MustacheRDF.prototype.init = function() {
  var that = this;

  // do loop
  var loopReplaced = $('body').html().replace(this.loopBlock, function(){
    console.log(arguments);
    var htmlToLoop = arguments[2];
    var triple = arguments[1]; 

    var html = '';
    var arr = that.findPattern(triple);
    for(var i in arr) {
      html += htmlToLoop.replace(that.singleBlock, arr[i]);  
    }
    return html;
  });
  $('body').html(loopReplaced);

  // replace all instance of curly
  var replaced = $('body').html().replace(this.reg, function() {
    var triple = arguments[1]; 

    var arr = that.findPattern(triple);
    
    return arr[0];
  });

  $('body').html(replaced);
}

MustacheRDF.prototype.expandTriple = function(triple) {
  // break it into triples, they're separated by space
  var tripleArr = triple.split(' ');

  // for each triple, see if it starts with a namespace in this.ns
  for(var i in tripleArr) {

    // replace 'a' with rdf:type
    if(tripleArr[i] == 'a') {
      tripleArr[i] = 'rdf:type';
    }

    // expand namespaces
    for(var n in this.ns) {
      if(tripleArr[i].startsWith(n)) {
        tripleArr[i] = tripleArr[i].replace(n, this.ns[n], 'g'); 
        break;
      }
    }

  }

  return tripleArr;
}
MustacheRDF.prototype.findTriple = function(triple) {
  var ret = [];

  var arg = ['subject', 'predicate', 'object'];

  // supporting only 1 arg for now
  for(var x in triple) {
    if(triple[x].startsWith('?')) {
      arg = arg[x];
      break;
    }
  }

  for(var i in this.rdf) {
    var subject = this.rdf[i].subject;
    var predicate = this.rdf[i].predicate;
    var object = this.rdf[i].object;

    if(
      (triple[0].startsWith('?') || triple[0] == subject)
      &&
      (triple[1].startsWith('?') || triple[1] == predicate)
      &&
      (triple[2].startsWith('?') || triple[2] == object)
    ){
      // matched
      ret.push(this.rdf[i][arg]);

    }

  }

  return ret;
}

MustacheRDF.prototype.findPattern = function(triple) {
  var tripleArr = this.expandTriple(triple);

  var arr = this.findTriple(tripleArr);
  return arr;
}


$(function(){
  
  var url = 'cco.ttl';

  $.get(url, function(data) {
    // atob() breaks with newlines, so remove them
    //var ttl = atob(data.data.content.replace(/\s/g, ''));
    var ttl = data;

    var turtle = new ParseTurtle();

    // do parsing and get namespaces
    var rdf = turtle.parse(ttl);
    var ns = turtle.ns;

    // now, with these two piece of info.
    // use jquery to find {{..}} elements
    // and modify them directly
    new MustacheRDF(rdf, ns);

  })  
});

</script>

</head>

<body>
  <h1>{{cco: dc:title ?o}}, <small>{{cco: dc:hasVersion ?o}}</small><br /></h1>

  <h2>Namespace Document 9 August 2010 - <em>Marco Polo Edition</em></h2>

  <dl>
    <dt>Latest version:</dt>
    <dd><a href="{{cco: foaf:page ?o}}">{{cco: foaf:page ?o}}</a> (<a href="{{cco: foaf:page ?o}}.ttl">RDF Turtle</a>)</dd>

    <dt>Contributors:</dt>

    <dd>
    {{#cco: dc:contributor ?cont}}
      {{.}},
    {{/}}
    </dd>

  </dl>

  <p class="copyright">Copyright &#169; 2013</p>
  <div about=""  resource="http://www.w3.org/TR/rdfa-syntax"  rel="dct:conformsTo" />
  <p about=""><a href="http://validator.w3.org/check?uri=referer"><img style="border: 0; float: right; padding: 5px;" 
        src="http://www.w3.org/Icons/valid-xhtml-rdfa-blue"   alt="Valid XHTML + RDFa"  /></a>

  <!-- Creative Commons License -->
   <a href="http://creativecommons.org/licenses/by/1.0/"></a> This work is licensed under a <a  rel="license" href= 
  "http://creativecommons.org/licenses/by/1.0/">Creative Commons Attribution License</a>. This copyright applies to the <em>FOAF Vocabulary Specification</em> and accompanying documentation in RDF. Regarding underlying technology, FOAF uses W3C's <a href="http://www.w3.org/RDF/">RDF</a> technology, an open Web standard that can be freely used by anyone.</p>
  
  <hr />

</body>
</html>

