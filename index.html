<html>
<head>
  <title>{{cco: dc:title ?o}}</title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <link href="http://xmlns.com/xmlns-style.css" rel="stylesheet"  type="text/css" />
  <link href="http://smiy.sourceforge.net/css/style.css" rel="stylesheet"  type="text/css" />
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
  <script type="text/javascript" src="turtle.js"></script>

<script>
// need this function
if (typeof String.prototype.startsWith != 'function') {
  String.prototype.startsWith = function (str){
    return this.slice(0, str.length) == str;
  };
}

function MustacheRDF(rdf, ns) {
  this.rdf = rdf;
  this.ns = ns;

  this.reg = /{{(.*?)}}/g; // this is for curly brackets
  
  this.loopBlock = /{{#(.*?)}}([\s\S]*?){{\/}}/g;
  this.singleBlock = /{{\.}}/g;

  this.init();
}
MustacheRDF.prototype.init = function() {
  var that = this;

  // do loop
  var loopReplaced = $('body').html().replace(this.loopBlock, function(){
    //console.log(arguments);
    var htmlToLoop = arguments[2];
    var triple = arguments[1]; 

    var html = '';
    var obj = that.findPattern(triple);
    var arr = obj.matches;

    for(var i in arr) {
      html += htmlToLoop.replace(that.reg, function() {
        // {{?s rdfs:label ?label}} -> {{cco:xx rdfs:label ?label}}
        // transform the variable found into full uri
        var triple = arguments[1]; 
        if(triple == '.') {
          return arr[i];
        } else {
          triple = triple.replace(obj.argName, arr[i]);

          var a = that.findPattern(triple).matches;
          return a[0];
        }
      });
      
    }
    return html;
  });
  $('body').html(loopReplaced);

  // replace all instance of curly
  var replaced = $('body').html().replace(this.reg, function() {
    var triple = arguments[1]; 

    var arr = that.findPattern(triple).matches;
    
    return arr[0];
  });

  $('body').html(replaced);
}

MustacheRDF.prototype.expandTriple = function(triple) {
  // break it into triples, they're separated by space
  var tripleArr = triple.split(' ');

  // for each triple, see if it starts with a namespace in this.ns
  for(var i in tripleArr) {

    // replace 'a' with rdf:type
    if(tripleArr[i] == 'a') {
      tripleArr[i] = 'rdf:type';
    }

    // expand namespaces
    for(var n in this.ns) {
      if(tripleArr[i].startsWith(n)) {
        tripleArr[i] = tripleArr[i].replace(n, this.ns[n], 'g'); 
        break;
      }
    }

  }

  return tripleArr;
}
MustacheRDF.prototype.findTriple = function(triple) {
  var ret = {};
  ret.matches = [];

  var arg = ['subject', 'predicate', 'object'];

  // supporting only 1 arg for now
  for(var x in triple) {
    if(triple[x].startsWith('?')) {
      arg = arg[x];
      ret.argName = triple[x];
      break;
    }
  }

  for(var i in this.rdf) {
    var subject = this.rdf[i].subject;
    var predicate = this.rdf[i].predicate;
    var object = this.rdf[i].object;

    if(
      (triple[0].startsWith('?') || triple[0] == subject)
      &&
      (triple[1].startsWith('?') || triple[1] == predicate)
      &&
      (triple[2].startsWith('?') || triple[2] == object)
    ){
      // matched
      var str = this.rdf[i][arg];
      str = $.trim(str);
      str = str.replace(/^\\n|\\n$/g, ''); // remove newline from beginning and end
      str = str.replace(/\\n/g, '<br>');
      ret.matches.push(str);

    }

  }

  return ret;
}

MustacheRDF.prototype.findPattern = function(triple) {
  var tripleArr = this.expandTriple(triple);

  var obj = this.findTriple(tripleArr);
  return obj;
}


$(function(){
  
  var url = 'cco.ttl';

  $.get(url, function(data) {
    // atob() breaks with newlines, so remove them
    //var ttl = atob(data.data.content.replace(/\s/g, ''));
    var ttl = data;

    var turtle = new ParseTurtle();

    // do parsing and get namespaces
    var rdf = turtle.parse(ttl);
    var ns = turtle.ns;

    // now, with these two piece of info.
    // use jquery to find {{..}} elements
    // and modify them directly
    new MustacheRDF(rdf, ns);

  })  
});

function run() {

  $('img[src=undefined]').remove();
  $('script').remove();
  $('.specterm').each(function() {
    $this = $(this);
    var id = $this.attr('id');
    var ids = id.split('#');
    $this.attr('id', ids[1]);
  });
  $('title').text($('span.title').text());
}

</script>

</head>

<body>
  <h1><span class="title">{{cco: dc:title ?o}}</span>, <small>{{cco: dc:hasVersion ?o}}</small><br /></h1>

<table width="100%" border="0">
  <tbody><tr>

    <td>
  <dl>
    <dt>Latest version:</dt>
    <dd><a href="{{cco: foaf:page ?o}}">{{cco: foaf:page ?o}}</a> (<a href="{{cco: foaf:page ?o}}.ttl">RDF Turtle</a>)</dd>

    <dt>Contributors:</dt>

    <dd>
    {{#cco: dc:contributor ?cont}}
      {{.}},
    {{/}}
    </dd>

  </dl>

  <p class="copyright">Copyright &#169; 2013</p>

    </td>
    

    <td>
	<table style="border:2px dashed #FFCC00; font-size:small; padding:10px;" width="400" border="0" align="center">
  <center>
    <a href="{{cco: rdfs:seeAlso ?o}}"><img width="300" src="http://www.agrobiodiversity.org/files/cco-logo.png" /></a>
  </center>

                  <tbody><tr>
                        <td rowspan="2">
                        <img src="https://github.global.ssl.fastly.net/images/modules/logos_page/GitHub-Logo.png" width="120" alt="Github">
                        </td>
                        <td align="center"><b>Music Ontology Github project</b></td>
		</tr>
		<tr><td align="center">
			<a href="https://github.com/bioversity/cco">Source code, Tools</a></td>
                </tr>
                  <tr>

                        <td rowspan="2">

                         <img src="http://groups.google.com/groups/img/groups_medium.gif" height="58" width="150" alt="Google Groups">

                        </td>

                        <td align="center"><b>Discussion Group</b></td>

                  </tr>
                  <tr><td align="center"><a href="http://groups.google.com/group/#">Browse Archives</a></td>

                  </tr>
                </tbody></table>
	
    </td>
  </tr>

</tbody></table>

  <div about=""  resource="http://www.w3.org/TR/rdfa-syntax"  rel="dct:conformsTo" />
  <p about=""><a href="http://validator.w3.org/check?uri=referer"><img style="border: 0; float: right; padding: 5px;" 
        src="http://www.w3.org/Icons/valid-xhtml-rdfa-blue"   alt="Valid XHTML + RDFa"  /></a>

  <!-- Creative Commons License -->
   <a href="http://creativecommons.org/licenses/by/1.0/"></a> This work is licensed under a <a  rel="license" href= 
  "http://creativecommons.org/licenses/by/1.0/">Creative Commons Attribution License</a>. This copyright applies to the <em>{{cco: dc:title ?o}}</em> and accompanying documentation in RDF. Regarding underlying technology, {{cco: dc:title ?o}} uses W3C's <a href="http://www.w3.org/RDF/">RDF</a> technology, an open Web standard that can be freely used by anyone.</p>
  
  <hr />

  <h2>Abstract</h2>

  <p>{{cco: dc:description ?o}}</p>

  <hr />

  <h2>{{cco: dc:title ?o}} At A Glance</h2>

<p>An alphabetical index of the terms, by class (categories or types), by

property and by individuals. All the terms are hyperlinked to their detailed description for quick reference.</p>

<div class="glance" id="glance">
<p>Classes: 

{{#?s a rdfs:Class}}

  | <a href="{{.}}">{{?s rdfs:label ?label}}</a> 

{{/}}

</p>
<p>Properties: 

{{#?s a rdf:Property}}

  | <a href="{{.}}">{{?s rdfs:label ?label}}</a> 

{{/}}

</p>
</div>

<hr />

<h2>{{cco: dc:title ?o}}: Classes and Properties</h2>

<br>

{{#?s a rdfs:Class}}
<div class="specterm" id="{{.}}"><h3>Class: {{?s rdfs:label ?label}}</h3>
   {{?s rdfs:label ?label}}
   <br><br>

</div>
{{/}}

{{#?s a rdf:Property}}
<div class="specterm" id="{{.}}"><h3>Property: {{?s rdfs:label ?label}}</h3>
   {{?s rdfs:comment ?comment}}
   <br>
   <br>
   <img src="{{?s foaf:depiction ?depiction}}" />
   <br><br>

  <table style="th { float: top; }">
  <tbody>
    <tr>
    <th>Domain:</th>
    <td><a href="{{?s rdfs:domain ?domain}}">{{?s rdfs:domain ?domain}}</a></td>

    </tr>

    <tr>
    <th>Range:</th>
    <td><a href="http://www.w3.org/2001/XMLSchema#string">xsd:string</a></td>
    </tr>
  </tbody></table>
   
</div>
{{/}}


<h2>Acknowledgments</h2>
<p>{{cco: dc:acknowledgments ?o}}</p>



</body>
</html>

